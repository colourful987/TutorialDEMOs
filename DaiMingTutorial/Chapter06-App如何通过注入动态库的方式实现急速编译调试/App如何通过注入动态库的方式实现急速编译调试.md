#  06 | App如何通过注入动态库的方式实现急速编译调试

文章提及三种注入的实际场景：

1. Swift Playground，然没有说实现原理；
2. Flutter Hot Reload，作为跨平台方案"新秀“，目前势头很猛，之前也跟随官方文档把教程过了一遍（官方文档整体来看不错，非常适合我这种入门菜鸟，加上环境部署，IDE安装花了差不多一星期），之后本来想学习下Flutter渲染底层原理，因为说到它都会提及Flutter自己底层实现了一套渲染机制，但是最后不了了之。
   * [ ] 【待研究】Flutter 热更新机制：**点击 reload 时对比上次编译以后改动过的代码，重新编译涉及到的代码库，还包括主库，以及主库依赖的库。所有这些重新编译过的库都会转成内核文件发到Dart VM中， Dart VM会重新加载新的内核文件，加载后让 Flutter framework触发所有 Widgets 和Render Objects进行重建、重新布局、重新绘制。**
3. Injection for Xcode，这个从插件时代就在使用，现在 John Holdsworth 已经开发了一款Mac App，内部同样是开了一个服务，通过 Socket 和App通信交换 dylib 动态库；
   1. **如何监听？**以Mac App为例，会让你选择项目文件目录，一旦目录中有文件变动就会触发一次增量编译，重新编译成dylib动态库，通过socket发送给App。这个实现不难，后面会补上；
   2. **如何替换？**Client 端接收后自然就要把旧类替换掉，这里使用方法交换就可以了；

## Injection 实现原理剖析

之前小组分享过这个，如果让你来实现动态注入、热更新，如何做呢？分几个关键步骤：

1. 首先监听项目中的文件变化，包括文件的增删、改动，这个Mac已经有现成的实现，按下不表；
2. 增量编译？但是有个问题，改动的文件大部分情况都会`#import`一些依赖文件，这个时候编译怎么玩？文件是编译成`.o`目标文件吗？
3. 安装到模拟器中的App程序已经运行起来了，想要把改动 apply 到程序中，只能借助 dyld，dlopen打开动态库即可，因此上面编译出来的产物最后应该是一个 `.dylib`动态库文件；
4. 通过socket将动态库发送给应用程序，这里自然还得靠客户端App协助才能实现，我们的项目中必须也要开启一个Socket服务，项目中必须加这段代码： ` [[NSBundle bundleWithPath:@"/Applications/InjectionIII.app/Contents/Resources/iOSInjection.bundle"] load];`
5. 最后就是借助 method swizzle 方法替换即可；



### 1. 如何监听项目文件夹状态变更？

### 2. 如何编译动态库以及在项目中加载动态库使用？

### 3. 如何创建 Server 和 Client Socket通信？

### 4. 如何将动态库中的新代码替换旧的？







































